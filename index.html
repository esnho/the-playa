<h1>The playa</h1>
<button id="play-button">PLAY!</button>
<button id="stop-button">STOP </button>
<div id="nowplaying"></div>
<!-- download the audio library <3 -->
<script src="https://cdn.jsdelivr.net/npm/howler@2.2.0/dist/howler.min.js"></script>

<script type="text/javascript">

let sound; // this will be the howler instance
const basses = []; // the bass array, is empty, will be filled automatically below
const drums = []; // the drums array, same as above
const nowplaying = document.getElementById("nowplaying");
let config = {};

window.onload = () => letsbegin();

function letsbegin() {
  getSprites()
  .then((audioSprites) => {
    console.log("audioSprites",audioSprites)
    for (let soundName in audioSprites.sprite) {
      if (soundName.indexOf("bass") >= 0) { // if the name contains the word bass
        basses.push(soundName);
      } else { // is a drum!
        drums.push(soundName);
      }
      const title = document.createElement("p");
      title.id = soundName;
      title.innerHTML = soundName;
      nowplaying.appendChild(title);
    }
    sound = new Howl(audioSprites);
    sound.autoSuspend = false;
    play = true;
    document.getElementById("stop-button").onclick = () => {
      sound.stop();
      play = false;
    }
    document.getElementById("play-button").onclick = () => {

      let time = 0;
      let bid = undefined;
      let did = undefined;

      play = true;

      const loop = () => {
        if (!play) return;
        const curtime = window.performance.now();
        if (curtime - time < 4000) {
          // nuttin
        } else {
          time = window.performance.now();
          const bass = basses[Math.ceil(Math.random()*basses.length-1)];
          const drum = drums[Math.ceil(Math.random()*drums.length-1)];
          if (bid !== undefined && did !== undefined) {
            sound.stop(bid);
            sound.stop(did);
          }
          bid = sound.play(bass);
          did = sound.play(drum);
          console.log(
            "loop",
            bass,
            bid,
            drum,
            did,
          );
          nowplaying.childNodes.forEach((title) => {
            console.log(title.id);
            if (title.id === bass || title.id === drum) {
              title.style.color = "red";
            } else {
              title.style.color = "black";
            }
          })
        }
        window.requestAnimationFrame(loop);
      }
      loop();
    }
  });
  
}

function getSprites() {
  return fetch(window.origin + "/config.json")
  .then((body) => {
    return body.json();
  })
  .then((json) => {
    config = json;
    return fetch(window.origin+"/"+config.filename);
  })
  .then((body) => {
    return body.json();
  })
}
</script>

<!--
convertire i file in sprites con https://github.com/tonistiigi/audiosprite // TODO scrivere how-to
caricare gli sprites generati da questo file
fare play di piÃ¹ sprite contemporanieamente mantenendo separati i tipi di file
ogni volta che finisce uno sprite deve riprodurre un altro sprite dello stesso genere
ascoltare la musica kwertchosa

-->