<h1>The playa</h1>
<button id="play-button">PLAY!</button>
<div id="nowplaying"></div>
<!-- download the audio library <3 -->
<script src="https://cdn.jsdelivr.net/npm/howler@2.2.0/dist/howler.min.js"></script>

<script type="text/javascript">

let sound;
const basses = []; // the bass array, is empty, will be filled automatically below
const drums = []; // the drums array, same as above
const spriteMap = {};
const nowplaying = document.getElementById("nowplaying");

// when the window is ready execute what is written in letsbegin()
window.onload = () => letsbegin();

function letsbegin() {
  for (let soundName in audioSprites.spritemap) {
    if (soundName.indexOf("bass") >= 0) { // if the name contains the word bass
      basses.push(soundName);
    } else { // is a drum!
      drums.push(soundName);
    }
    const title = document.createElement("p");
    title.id = soundName;
    title.innerHTML = soundName;
    nowplaying.appendChild(title);
    spriteMap[soundName] = [
      audioSprites.spritemap[soundName].start * 1000,
      audioSprites.spritemap[soundName].end * 1000,
    ]
  }
  const sprites = {
    src: audioSprites.resources,
    sprite: spriteMap,
  }
  console.log(sprites);
  sound = new Howl(sprites);
  document.getElementById("play-button").onclick = () => {

    let time = 0;
    let bid = undefined;
    let did = undefined;

    const loop = () => {
      const curtime = window.performance.now();
      if (curtime - time < 4000) {
        // nuttin
      } else {
        time = window.performance.now();
        const bass = basses[Math.ceil(Math.random()*basses.length-1)];
        const drum = drums[Math.ceil(Math.random()*drums.length-1)];
        if (bid !== undefined && did !== undefined) {
          sound.stop(bid);
          sound.stop(did);
        }
        bid = sound.play(bass);
        did = sound.play(drum);
        console.log(
          "loop",
          bass,
          bid,
          drum,
          did,
        );
        nowplaying.childNodes.forEach((title) => {
          console.log(title.id);
          if (title.id === bass || title.id === drum) {
            title.style.color = "red";
          } else {
            title.style.color = "black";
          }
        })
      }
      // window.requestAnimationFrame(loop);
    }
    //loop();

    const nowPlayingUpdate = (p = {
      bass:undefined,
      drum:undefined
    }) => {
      nowplaying.childNodes.forEach((title) => {
        if ((p.bass && title.id === p.bass) || (p.drum && title.id === p.drum)) {
          title.style.color = "red";
        } else {
          title.style.color = "black";
        }
      })
    }

    const infiniteBass = () => {
      const bass = basses[Math.ceil(Math.random()*basses.length-1)];
      const id = sound.play(bass);
      console.log("bass",bass,id);
      nowPlayingUpdate({bass});
      sound.on('end', function() {
        infiniteBass();
      }, id);
    }

    const infiniteDrum = () => {
      const drum = drums[Math.ceil(Math.random()*drums.length-1)];
      const id = sound.play(drum);
      console.log("drum",drum,id);
      nowPlayingUpdate({drum});
      sound.on('end', function() {
        infiniteDrum();
      }, id);
    }
    infiniteBass();
    infiniteDrum();
  }
}

const audioSprites = {
  "resources": [
    "audio/mygameaudio.ogg",
    "audio/mygameaudio.m4a",
    "audio/mygameaudio.mp3",
    "audio/mygameaudio.ac3"
  ],
  "spritemap": {
    "120_basic-flubby-bass": {
      "start": 0,
      "end": 4,
      "loop": false
    },
    "120_deeply-bassy-reaktor-drone": {
      "start": 5,
      "end": 9,
      "loop": false
    },
    "120_pretty-ping-pong-synthbass": {
      "start": 10,
      "end": 14,
      "loop": false
    },
    "120_growly-thudderbass": {
      "start": 16,
      "end": 20,
      "loop": false
    },
    "120_iLLHumanAni-trap-hat-trills": {
      "start": 22,
      "end": 26,
      "loop": false
    },
    "120_industrial-deepgate-1": {
      "start": 28,
      "end": 32,
      "loop": false
    },
    "120_just-some-crunchy-snares": {
      "start": 33,
      "end": 37,
      "loop": false
    }
  }
};
</script>

<!--
convertire i file in sprites con https://github.com/tonistiigi/audiosprite // TODO scrivere how-to
caricare gli sprites generati da questo file
fare play di piÃ¹ sprite contemporanieamente mantenendo separati i tipi di file
ogni volta che finisce uno sprite deve riprodurre un altro sprite dello stesso genere
ascoltare la musica kwertchosa

-->